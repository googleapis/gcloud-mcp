steps:
  - name: 'node:20'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -e -o pipefail

        echo "--- Installing gcloud CLI ---"
        export DEBIAN_FRONTEND=noninteractive
        apt-get update && apt-get install -y apt-transport-https ca-certificates gnupg curl
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee /etc/apt/sources.list.d/google-cloud-sdk.list
        curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
        apt-get update && apt-get install -y --no-install-recommends google-cloud-cli

        echo "--- Running gcloud info ---"
        gcloud info

        echo "--- Installing Node dependencies and building ---"
        npm install
        cd packages/gcloud-mcp
        npm link
        cd ../..
        cd packages/cloud-observability-mcp
        npm link
        cd ../..
        npm install -g @google/gemini-cli

        echo "--- Initializing servers with Gemini CLI"
        npx gcloud-mcp init --agent=gemini-cli --local
        npx cloud-observability-mcp init --agent=gemini-cli --local

        echo "--- Installing Go ---"
        apt-get install -y golang

        echo "--- Building and running Go integration tests ---"
        go build -o /workspace/integration-test tests/integration/main.go
        /workspace/integration-test

options:
  logging: CLOUD_LOGGING_ONLY
